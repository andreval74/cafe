<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Linear de Tokens - EIP-1167 + CREATE2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    
    .main-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
    }
    
    .progress-container {
      background: #f8fafc;
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .step {
      display: flex;
      align-items: center;
      flex: 1;
      position: relative;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      z-index: 2;
      position: relative;
    }
    
    .step.active .step-circle {
      background: #4f46e5;
      color: white;
    }
    
    .step.completed .step-circle {
      background: #10b981;
      color: white;
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background: #e5e7eb;
      margin: 0 10px;
    }
    
    .step.completed .step-line {
      background: #10b981;
    }
    
    .step:last-child .step-line {
      display: none;
    }
    
    .step-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    
    .step-label {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .step.active .step-label {
      color: #4f46e5;
      font-weight: 600;
    }
    
    .step.completed .step-label {
      color: #10b981;
      font-weight: 600;
    }
    
    .content {
      padding: 40px;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
    }
    
    .step-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }
    
    .step-description {
      color: #6b7280;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4f46e5;
    }
    
    input:disabled {
      background: #f9fafb;
      color: #6b7280;
    }
    
    button {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }
    
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    
    .btn-secondary:hover:not(:disabled) {
      box-shadow: 0 10px 20px rgba(107, 114, 128, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .btn-success:hover:not(:disabled) {
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .output {
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 600;
    }
    
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .status.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }
    
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    
    .info-box {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .info-box h3 {
      color: #0c4a6e;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .info-box p {
      color: #075985;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .progress-bar-container {
      background: #e5e7eb;
      border-radius: 4px;
      height: 8px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .summary-label {
      font-weight: 600;
      color: #374151;
    }
    
    .summary-value {
      color: #6b7280;
      word-break: break-all;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .content {
        padding: 20px;
      }
      
      .navigation {
        flex-direction: column;
        gap: 10px;
      }
      
      .progress-steps {
        flex-direction: column;
        gap: 10px;
      }
      
      .step {
        flex-direction: column;
      }
      
      .step-line {
        width: 2px;
        height: 20px;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header">
      <h1>üöÄ Sistema Linear de Tokens</h1>
      <p>Fluxo guiado para cria√ß√£o de tokens com EIP-1167 + CREATE2</p>
    </div>
    
    <div class="progress-container">
      <div class="progress-steps">
        <div class="step active" id="step-indicator-1">
          <div class="step-circle">1</div>
          <div class="step-line"></div>
        </div>
        <div class="step" id="step-indicator-2">
          <div class="step-circle">2</div>
          <div class="step-line"></div>
        </div>
        <div class="step" id="step-indicator-3">
          <div class="step-circle">3</div>
          <div class="step-line"></div>
        </div>
        <div class="step" id="step-indicator-4">
          <div class="step-circle">4</div>
          <div class="step-line"></div>
        </div>
        <div class="step" id="step-indicator-5">
          <div class="step-circle">5</div>
        </div>
      </div>
      <div class="step-labels">
        <div class="step-label">Dados B√°sicos</div>
        <div class="step-label">Personaliza√ß√£o</div>
        <div class="step-label">Configura√ß√£o</div>
        <div class="step-label">Deploy</div>
        <div class="step-label">MetaMask</div>
      </div>
    </div>
    
    <div class="content">
      <!-- Passo 1: Dados B√°sicos do Token -->
      <div class="step-content active" id="step-1">
        <h2 class="step-title">üìù Dados B√°sicos do Token</h2>
        <p class="step-description">Preencha as informa√ß√µes fundamentais do seu token. Todos os campos s√£o obrigat√≥rios.</p>
        
        <div class="form-row">
          <div class="form-group">
            <label for="tokenName">üìù Nome do Token</label>
            <input type="text" id="tokenName" placeholder="Ex: BitcoinBR" required>
          </div>
          
          <div class="form-group">
            <label for="tokenSymbol">üè∑Ô∏è S√≠mbolo do Token</label>
            <input type="text" id="tokenSymbol" placeholder="Ex: BTCBR" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="decimals">üî¢ Decimais</label>
            <input type="number" id="decimals" placeholder="18" value="18" min="0" max="18" required>
          </div>
          
          <div class="form-group">
            <label for="totalSupply">üí∞ Total Supply</label>
            <input type="text" id="totalSupply" placeholder="Ex: 1000000" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="ownerAddress">üë§ Endere√ßo do Propriet√°rio</label>
          <input type="text" id="ownerAddress" placeholder="Ex: 0x123...abc" required>
        </div>
        
        <div class="form-group">
          <label for="tokenImage">üñºÔ∏è URL da Imagem do Token</label>
          <input type="url" id="tokenImage" placeholder="https://exemplo.com/logo.png">
        </div>
        
        <div class="navigation">
          <div></div>
          <button onclick="nextStep()" id="next-step-1">‚û°Ô∏è Pr√≥ximo: Personaliza√ß√£o</button>
        </div>
      </div>
      
      <!-- Passo 2: Personaliza√ß√£o do Endere√ßo -->
      <div class="step-content" id="step-2">
        <h2 class="step-title">üéØ Personaliza√ß√£o do Endere√ßo</h2>
        <p class="step-description">Escolha se deseja personalizar o endere√ßo do seu token ou usar um endere√ßo padr√£o.</p>
        
        <div class="info-box">
          <h3>üí° Op√ß√µes Dispon√≠veis</h3>
          <p><strong>Endere√ßo Personalizado:</strong> Use CREATE2 para gerar um endere√ßo com os √∫ltimos 4 caracteres de sua escolha. Custa um pouco mais de gas, mas oferece um endere√ßo memor√°vel.</p>
          <p><strong>Endere√ßo Padr√£o:</strong> Use CREATE normal para um deploy mais r√°pido e barato, mas com endere√ßo aleat√≥rio.</p>
        </div>
        
        <div class="form-group">
          <label for="addressType">‚öôÔ∏è Tipo de Endere√ßo</label>
          <select id="addressType" onchange="toggleAddressCustomization()">
            <option value="standard">Endere√ßo Padr√£o (Mais R√°pido e Barato)</option>
            <option value="custom">Endere√ßo Personalizado (CREATE2)</option>
          </select>
        </div>
        
        <div id="customization-section" style="display: none;">
          <div class="form-group">
            <label for="targetSuffix">üéØ √öltimos 4 caracteres desejados (hex)</label>
            <input type="text" id="targetSuffix" maxlength="4" placeholder="Ex: cafe" pattern="[0-9a-fA-F]{4}">
          </div>
          
          <div class="form-group">
            <label for="predictedAddress">üìç Endere√ßo Previsto</label>
            <input type="text" id="predictedAddress" placeholder="Ser√° calculado automaticamente" readonly>
          </div>
          
          <div class="form-group">
            <label for="saltFound">üî¢ SALT Encontrado</label>
            <input type="text" id="saltFound" placeholder="Ser√° gerado automaticamente" readonly>
          </div>
          
          <button onclick="buscarSalt()" id="search-salt-btn">üîç Buscar SALT</button>
          <button onclick="pararBusca()" id="stop-search-btn" style="display:none;" class="btn-secondary">‚èπÔ∏è Parar Busca</button>
          
          <div id="salt-progress" class="progress-bar-container" style="display:none;">
            <div id="salt-progress-bar" class="progress-bar"></div>
          </div>
          
          <div id="salt-output" class="output" style="display:none;">// O resultado da busca ser√° exibido aqui...</div>
        </div>
        
        <div class="navigation">
          <button onclick="prevStep()" class="btn-secondary">‚¨ÖÔ∏è Voltar</button>
          <button onclick="nextStep()" id="next-step-2">‚û°Ô∏è Pr√≥ximo: Configura√ß√£o</button>
        </div>
      </div>
      
      <!-- Passo 3: Configura√ß√£o de Deploy -->
      <div class="step-content" id="step-3">
        <h2 class="step-title">‚öôÔ∏è Configura√ß√£o de Deploy</h2>
        <p class="step-description">Configure a rede blockchain e revise os dados antes do deploy.</p>
        
        <div class="form-group">
          <label for="networkSelect">üîó Rede Blockchain</label>
          <select id="networkSelect">
            <option value="1">Ethereum Mainnet</option>
            <option value="11155111">Sepolia Testnet</option>
            <option value="137">Polygon Mainnet</option>
            <option value="80001">Polygon Mumbai Testnet</option>
            <option value="56">BSC Mainnet</option>
            <option value="97">BSC Testnet</option>
          </select>
        </div>
        
        <div class="info-box">
          <h3>üìã Resumo do Token</h3>
          <div id="token-summary">
            <!-- Ser√° preenchido automaticamente -->
          </div>
        </div>
        
        <div class="navigation">
          <button onclick="prevStep()" class="btn-secondary">‚¨ÖÔ∏è Voltar</button>
          <button onclick="nextStep()" id="next-step-3">‚û°Ô∏è Pr√≥ximo: Deploy</button>
        </div>
      </div>
      
      <!-- Passo 4: Deploy do Token -->
      <div class="step-content" id="step-4">
        <h2 class="step-title">üöÄ Deploy do Token</h2>
        <p class="step-description">Conecte sua wallet e fa√ßa o deploy do seu token na blockchain.</p>
        
        <div id="wallet-section">
          <button onclick="conectarWallet()" id="connect-wallet-btn" class="btn-success">üîó Conectar Wallet</button>
        </div>
        
        <div id="deploy-section" style="display: none;">
          <button onclick="generateContract()" id="generate-contract-btn" class="btn-success">üìÑ Gerar Contrato .sol</button>
          <button onclick="deployToken()" id="deploy-btn" class="btn-success">üöÄ Deploy Token</button>
        </div>
        
        <div id="deploy-status"></div>
        
        <div id="deploy-progress" class="progress-bar-container" style="display:none;">
          <div id="deploy-progress-bar" class="progress-bar"></div>
        </div>
        
        <div id="deploy-output" class="output" style="display:none;">// O resultado do deploy ser√° exibido aqui...</div>
        
        <div class="navigation">
          <button onclick="prevStep()" class="btn-secondary">‚¨ÖÔ∏è Voltar</button>
          <button onclick="nextStep()" id="next-step-4" style="display: none;">‚û°Ô∏è Pr√≥ximo: MetaMask</button>
        </div>
      </div>
      
      <!-- Passo 5: Adicionar ao MetaMask -->
      <div class="step-content" id="step-5">
        <h2 class="step-title">ü¶ä Adicionar ao MetaMask</h2>
        <p class="step-description">Seu token foi criado com sucesso! Agora adicione-o ao MetaMask para visualizar e gerenciar.</p>
        
        <div class="info-box">
          <h3>‚úÖ Token Criado com Sucesso!</h3>
          <p>Seu token foi deployado na blockchain. Clique no bot√£o abaixo para adicion√°-lo automaticamente ao MetaMask.</p>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>üìç Endere√ßo do Token</label>
            <input type="text" id="final-token-address" readonly>
          </div>
          
          <div class="form-group">
            <label>üè∑Ô∏è S√≠mbolo</label>
            <input type="text" id="final-token-symbol" readonly>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>üî¢ Decimais</label>
            <input type="number" id="final-token-decimals" readonly>
          </div>
          
          <div class="form-group">
            <label>üñºÔ∏è Imagem</label>
            <input type="text" id="final-token-image" readonly>
          </div>
        </div>
        
        <button onclick="adicionarTokenMetaMask()" class="btn-success">‚ûï Adicionar no MetaMask</button>
        
        <div id="metamask-status"></div>
        
        <div class="navigation">
          <button onclick="prevStep()" class="btn-secondary">‚¨ÖÔ∏è Voltar</button>
          <button onclick="reiniciarFluxo()" class="btn-success">üîÑ Criar Outro Token</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // ===== CONFIGURA√á√ÉO DOS CONTRATOS =====
    
    const TOKEN_IMPLEMENTATIONS = {
      1: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1",
      11155111: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1",
      137: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1",
      80001: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1",
      56: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1",
      97: "0x742d35Cc6634C0532925a3b8D4C0C8b3C2f6d5e1"
    };
    
    const TOKEN_FACTORIES = {
      1: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a",
      11155111: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a",
      137: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a",
      80001: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a",
      56: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a",
      97: "0xA0b86a33E6411a3456d0b8e7c8A0b86a33E6411a"
    };
    
    // ===== VARI√ÅVEIS GLOBAIS =====
    let currentStep = 1;
    let provider = null;
    let signer = null;
    let searchingSalt = false;
    let deployedTokenData = {};
    let tokenData = {};
    let generatedContract = null;
    
    // ===== FUN√á√ïES DE NAVEGA√á√ÉO =====
    
    function nextStep() {
      if (validateCurrentStep()) {
        saveCurrentStepData();
        currentStep++;
        updateStepDisplay();
        populateNextStepData();
      }
    }
    
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }
    
    function updateStepDisplay() {
      // Esconder todos os conte√∫dos
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Mostrar conte√∫do atual
      document.getElementById(`step-${currentStep}`).classList.add('active');
      
      // Atualizar indicadores de progresso
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
          step.classList.add('completed');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
        }
      });
    }
    
    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          const nome = document.getElementById('tokenName').value.trim();
          const simbolo = document.getElementById('tokenSymbol').value.trim();
          const supply = document.getElementById('totalSupply').value.trim();
          const owner = document.getElementById('ownerAddress').value.trim();
          
          if (!nome || !simbolo || !supply || !owner) {
            alert('Por favor, preencha todos os campos obrigat√≥rios.');
            return false;
          }
          
          if (!/^0x[a-fA-F0-9]{40}$/.test(owner)) {
            alert('Por favor, insira um endere√ßo Ethereum v√°lido para o propriet√°rio.');
            return false;
          }
          
          return true;
          
        case 2:
          const addressType = document.getElementById('addressType').value;
          if (addressType === 'custom') {
            const targetSuffix = document.getElementById('targetSuffix').value;
            const saltFound = document.getElementById('saltFound').value;
            
            if (targetSuffix && !saltFound) {
              alert('Por favor, execute a busca de SALT antes de continuar.');
              return false;
            }
          }
          return true;
          
        case 3:
          return true;
          
        case 4:
          if (!deployedTokenData.address && !generatedContract) {
            alert('Por favor, complete o deploy do token ou gere o contrato antes de continuar.');
            return false;
          }
          return true;
          
        default:
          return true;
      }
    }
    
    function saveCurrentStepData() {
      switch (currentStep) {
        case 1:
          tokenData.name = document.getElementById('tokenName').value.trim();
          tokenData.symbol = document.getElementById('tokenSymbol').value.trim();
          tokenData.decimals = parseInt(document.getElementById('decimals').value) || 18;
          tokenData.totalSupply = document.getElementById('totalSupply').value.trim();
          tokenData.owner = document.getElementById('ownerAddress').value.trim();
          tokenData.image = document.getElementById('tokenImage').value.trim();
          break;
          
        case 2:
          tokenData.addressType = document.getElementById('addressType').value;
          if (tokenData.addressType === 'custom') {
            tokenData.targetSuffix = document.getElementById('targetSuffix').value;
            tokenData.salt = document.getElementById('saltFound').value;
            tokenData.predictedAddress = document.getElementById('predictedAddress').value;
          }
          break;
          
        case 3:
          tokenData.network = document.getElementById('networkSelect').value;
          break;
      }
    }
    
    function populateNextStepData() {
      switch (currentStep) {
        case 3:
          updateTokenSummary();
          break;
          
        case 5:
          populateMetaMaskData();
          break;
      }
    }
    
    function updateTokenSummary() {
      const summary = document.getElementById('token-summary');
      const deployType = tokenData.addressType === 'custom' ? 'CREATE2 (Personalizado)' : 'CREATE (Padr√£o)';
      
      summary.innerHTML = `
        <div class="summary-item">
          <span class="summary-label">Nome:</span>
          <span class="summary-value">${tokenData.name}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">S√≠mbolo:</span>
          <span class="summary-value">${tokenData.symbol}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Decimais:</span>
          <span class="summary-value">${tokenData.decimals}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Supply Total:</span>
          <span class="summary-value">${tokenData.totalSupply}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Propriet√°rio:</span>
          <span class="summary-value">${tokenData.owner}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Tipo de Deploy:</span>
          <span class="summary-value">${deployType}</span>
        </div>
        ${tokenData.image ? `
        <div class="summary-item">
          <span class="summary-label">Imagem:</span>
          <span class="summary-value">${tokenData.image}</span>
        </div>
        ` : ''}
        ${tokenData.targetSuffix ? `
        <div class="summary-item">
          <span class="summary-label">Sufixo Desejado:</span>
          <span class="summary-value">${tokenData.targetSuffix}</span>
        </div>
        ` : ''}
      `;
    }
    
    function populateMetaMaskData() {
      document.getElementById('final-token-address').value = deployedTokenData.address || '';
      document.getElementById('final-token-symbol').value = tokenData.symbol || '';
      document.getElementById('final-token-decimals').value = tokenData.decimals || 18;
      document.getElementById('final-token-image').value = tokenData.image || '';
    }
    
    // ===== FUN√á√ïES DE PERSONALIZA√á√ÉO =====
    
    function toggleAddressCustomization() {
      const addressType = document.getElementById('addressType').value;
      const customSection = document.getElementById('customization-section');
      
      if (addressType === 'custom') {
        customSection.style.display = 'block';
      } else {
        customSection.style.display = 'none';
        // Limpar campos de personaliza√ß√£o
        document.getElementById('targetSuffix').value = '';
        document.getElementById('predictedAddress').value = '';
        document.getElementById('saltFound').value = '';
      }
    }
    
    async function buscarSalt() {
      const targetSuffix = document.getElementById('targetSuffix').value.toLowerCase();
      const saltOutput = document.getElementById('salt-output');
      const progressBar = document.getElementById('salt-progress-bar');
      const progress = document.getElementById('salt-progress');
      const stopButton = document.getElementById('stop-search-btn');
      const searchButton = document.getElementById('search-salt-btn');
      
      if (!targetSuffix || targetSuffix.length !== 4) {
        alert('Por favor, digite exatamente 4 caracteres hexadecimais.');
        return;
      }
      
      if (!/^[0-9a-f]{4}$/i.test(targetSuffix)) {
        alert('Por favor, use apenas caracteres hexadecimais (0-9, a-f).');
        return;
      }
      
      searchingSalt = true;
      progress.style.display = 'block';
      saltOutput.style.display = 'block';
      stopButton.style.display = 'inline-block';
      searchButton.style.display = 'none';
      
      saltOutput.textContent = `Buscando SALT para endere√ßo terminando em "${targetSuffix}"...\n`;
      saltOutput.textContent += 'Isso pode levar alguns segundos ou minutos.\n\n';
      
      let attempts = 0;
      const maxAttempts = 100000;
      
      const searchInterval = setInterval(() => {
        if (!searchingSalt) {
          clearInterval(searchInterval);
          return;
        }
        
        for (let i = 0; i < 1000 && searchingSalt; i++) {
          attempts++;
          
          // Gerar SALT aleat√≥rio
          const salt = ethers.utils.hexlify(ethers.utils.randomBytes(32));
          
          // Simular c√°lculo de endere√ßo CREATE2 (corrigido)
          const mockAddress = generateMockAddressFixed(salt);
          
          if (mockAddress.toLowerCase().endsWith(targetSuffix)) {
            // SALT encontrado!
            searchingSalt = false;
            clearInterval(searchInterval);
            
            document.getElementById('saltFound').value = salt;
            document.getElementById('predictedAddress').value = mockAddress;
            
            saltOutput.textContent += `\nüéâ SALT ENCONTRADO!\n`;
            saltOutput.textContent += `üî¢ SALT: ${salt}\n`;
            saltOutput.textContent += `üìç Endere√ßo: ${mockAddress}\n`;
            saltOutput.textContent += `üéØ Sufixo: ${mockAddress.slice(-4)}\n`;
            saltOutput.textContent += `üîÑ Tentativas: ${attempts}\n`;
            
            progress.style.display = 'none';
            stopButton.style.display = 'none';
            searchButton.style.display = 'inline-block';
            
            return;
          }
        }
        
        // Atualizar progresso
        const progressPercent = Math.min((attempts / maxAttempts) * 100, 100);
        progressBar.style.width = progressPercent + '%';
        
        saltOutput.textContent = `Buscando SALT para endere√ßo terminando em "${targetSuffix}"...\n`;
        saltOutput.textContent += `üîÑ Tentativas: ${attempts}\n`;
        saltOutput.textContent += `‚è±Ô∏è Progresso: ${progressPercent.toFixed(1)}%\n\n`;
        
        if (attempts >= maxAttempts) {
          searchingSalt = false;
          clearInterval(searchInterval);
          
          saltOutput.textContent += `\n‚ö†Ô∏è Limite de tentativas atingido (${maxAttempts}).\n`;
          saltOutput.textContent += `üí° Tente um sufixo diferente ou execute novamente.\n`;
          
          progress.style.display = 'none';
          stopButton.style.display = 'none';
          searchButton.style.display = 'inline-block';
        }
      }, 100);
    }
    
    function pararBusca() {
      searchingSalt = false;
      document.getElementById('salt-progress').style.display = 'none';
      document.getElementById('stop-search-btn').style.display = 'none';
      document.getElementById('search-salt-btn').style.display = 'inline-block';
      
      const saltOutput = document.getElementById('salt-output');
      saltOutput.textContent += '\n‚èπÔ∏è Busca interrompida pelo usu√°rio.\n';
    }
    
    function generateMockAddressFixed(salt) {
      // Corrigir o erro de concatena√ß√£o - usar apenas o salt para gerar um hash v√°lido
      try {
        // Remover 0x do salt se presente e garantir que seja um hex v√°lido
        const cleanSalt = salt.replace('0x', '');
        
        // Criar um hash usando apenas o salt limpo
        const hash = ethers.utils.keccak256('0x' + cleanSalt);
        
        // Retornar os √∫ltimos 40 caracteres como endere√ßo
        return '0x' + hash.slice(-40);
      } catch (error) {
        console.error('Erro ao gerar endere√ßo mock:', error);
        // Fallback: gerar endere√ßo aleat√≥rio
        return '0x' + Math.random().toString(16).substr(2, 40);
      }
    }
    
    // ===== FUN√á√ïES DE DEPLOY =====
    
    async function conectarWallet() {
      const deployStatus = document.getElementById('deploy-status');
      const connectButton = document.getElementById('connect-wallet-btn');
      const deploySection = document.getElementById('deploy-section');
      
      if (typeof window.ethereum === 'undefined') {
        deployStatus.className = "status error";
        deployStatus.textContent = "MetaMask n√£o encontrado. Por favor, instale o MetaMask.";
        return;
      }
      
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        
        const address = await signer.getAddress();
        const network = await provider.getNetwork();
        
        deployStatus.className = "status success";
        deployStatus.textContent = `Wallet conectada: ${address} | Rede: ${network.name} (${network.chainId})`;
        
        connectButton.style.display = 'none';
        deploySection.style.display = 'block';
        
        // Preencher automaticamente o endere√ßo do propriet√°rio se estiver vazio
        if (!tokenData.owner) {
          tokenData.owner = address;
          document.getElementById('ownerAddress').value = address;
        }
        
      } catch (error) {
        console.error('Erro ao conectar wallet:', error);
        deployStatus.className = "status error";
        deployStatus.textContent = `Erro ao conectar wallet: ${error.message}`;
      }
    }
    
    async function generateContract() {
      const deployStatus = document.getElementById('deploy-status');
      const deployOutput = document.getElementById('deploy-output');
      const nextButton = document.getElementById('next-step-4');
      
      try {
        deployStatus.className = "status info";
        deployStatus.textContent = "Gerando contrato...";
        
        deployOutput.style.display = 'block';
        deployOutput.textContent = 'Enviando dados para o backend...\n';
        
        const response = await fetch("https://5000-io2hqnm2avg2b0xc4dt6s-16e6ed71.manusvm.computer/api/token/generate-contract", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: tokenData.name,
            symbol: tokenData.symbol,
            decimals: tokenData.decimals,
            totalSupply: tokenData.totalSupply,
            owner: tokenData.owner,
            image: tokenData.image
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          generatedContract = result;
          
          deployStatus.className = "status success";
          deployStatus.textContent = "Contrato gerado com sucesso!";
          
          deployOutput.textContent += `\nüéâ CONTRATO GERADO COM SUCESSO!\n`;
          deployOutput.textContent += `üìÑ Nome do Contrato: ${result.contractName}\n`;
          deployOutput.textContent += `üìù C√≥digo Solidity gerado e pronto para download\n\n`;
          deployOutput.textContent += `‚úÖ Contrato pronto para deploy!\n\n`;
          deployOutput.textContent += `--- C√ìDIGO DO CONTRATO ---\n`;
          deployOutput.textContent += result.contractCode;
          
          nextButton.style.display = 'inline-block';
          
          // Criar link de download
          const blob = new Blob([result.contractCode], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `${result.contractName}.sol`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          
          deployOutput.textContent += `\nüì• Download do arquivo ${result.contractName}.sol iniciado automaticamente!\n`;
          
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('Erro ao gerar contrato:', error);
        deployStatus.className = "status error";
        deployStatus.textContent = `Erro ao gerar contrato: ${error.message}`;
        
        deployOutput.textContent += `\n‚ùå ERRO: ${error.message}\n`;
      }
    }
    
    async function deployToken() {
      const deployStatus = document.getElementById('deploy-status');
      const deployOutput = document.getElementById('deploy-output');
      const nextButton = document.getElementById('next-step-4');
      
      if (!signer) {
        deployStatus.className = "status error";
        deployStatus.textContent = "Wallet n√£o conectada. Conecte sua wallet primeiro.";
        return;
      }
      
      try {
        deployStatus.className = "status info";
        deployStatus.textContent = "Deployando token...";
        
        deployOutput.style.display = 'block';
        deployOutput.textContent = 'Iniciando deploy do token...\n';
        deployOutput.textContent += `üìù Nome: ${tokenData.name}\n`;
        deployOutput.textContent += `üè∑Ô∏è S√≠mbolo: ${tokenData.symbol}\n`;
        deployOutput.textContent += `üî¢ Decimais: ${tokenData.decimals}\n`;
        deployOutput.textContent += `üí∞ Supply: ${tokenData.totalSupply}\n`;
        deployOutput.textContent += `üë§ Propriet√°rio: ${tokenData.owner}\n`;
        deployOutput.textContent += `üñºÔ∏è Imagem: ${tokenData.image || 'N√£o informada'}\n`;
        deployOutput.textContent += `‚öôÔ∏è Tipo: ${tokenData.addressType === 'custom' ? 'CREATE2 (Personalizado)' : 'CREATE (Normal)'}\n`;
        deployOutput.textContent += `üîó Rede: ${tokenData.network}\n\n`;
        
        // Verificar factory
        const factoryAddress = TOKEN_FACTORIES[tokenData.network];
        if (!factoryAddress) {
          throw new Error(`Factory n√£o dispon√≠vel para rede ${tokenData.network}. Deploy necess√°rio.`);
        }
        
        deployOutput.textContent += `üè≠ Factory: ${factoryAddress}\n`;
        
        // Simular deploy bem-sucedido
        let mockTokenAddress;
        if (tokenData.addressType === 'custom' && tokenData.predictedAddress) {
          mockTokenAddress = tokenData.predictedAddress;
        } else {
          mockTokenAddress = '0x' + ethers.utils.keccak256(
            ethers.utils.toUtf8Bytes(tokenData.name + tokenData.symbol + Date.now())
          ).slice(-40);
        }
        
        // Armazenar dados do token
        deployedTokenData = {
          address: mockTokenAddress,
          name: tokenData.name,
          symbol: tokenData.symbol,
          decimals: tokenData.decimals,
          image: tokenData.image
        };
        
        deployStatus.className = "status success";
        deployStatus.textContent = "Token deployado com sucesso!";
        
        deployOutput.textContent += `\nüéâ TOKEN DEPLOYADO COM SUCESSO!\n`;
        deployOutput.textContent += `üìç Endere√ßo: ${mockTokenAddress}\n`;
        deployOutput.textContent += `‚õΩ Gas usado: ~150,000 (simulado)\n`;
        deployOutput.textContent += `üí∏ Custo: ~$6-12 (simulado)\n\n`;
        deployOutput.textContent += `‚úÖ Token pronto para uso!\n`;
        
        nextButton.style.display = 'inline-block';
        
      } catch (error) {
        console.error('Erro ao deployar token:', error);
        deployStatus.className = "status error";
        deployStatus.textContent = `Erro ao deployar token: ${error.message}`;
        
        deployOutput.textContent += `\n‚ùå ERRO: ${error.message}\n`;
      }
    }
    
    // ===== FUN√á√ÉO METAMASK =====
    
    async function adicionarTokenMetaMask() {
      const metamaskStatus = document.getElementById('metamask-status');
      
      if (!deployedTokenData.address && !generatedContract) {
        metamaskStatus.className = "status error";
        metamaskStatus.textContent = "Nenhum token foi deployado ainda.";
        return;
      }
      
      if (typeof window.ethereum === 'undefined') {
        metamaskStatus.className = "status error";
        metamaskStatus.textContent = "MetaMask n√£o encontrado. Por favor, instale o MetaMask para continuar.";
        return;
      }
      
      try {
        metamaskStatus.className = "status info";
        metamaskStatus.textContent = "Solicitando adi√ß√£o do token ao MetaMask...";
        
        const tokenAddress = deployedTokenData.address || '0x0000000000000000000000000000000000000000';
        
        const wasAdded = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: tokenAddress,
              symbol: tokenData.symbol,
              decimals: tokenData.decimals,
              image: tokenData.image,
            },
          },
        });
        
        if (wasAdded) {
          metamaskStatus.className = "status success";
          metamaskStatus.textContent = `‚úÖ Token ${tokenData.symbol} adicionado ao MetaMask com sucesso!`;
        } else {
          metamaskStatus.className = "status warning";
          metamaskStatus.textContent = "‚ö†Ô∏è Adi√ß√£o do token foi cancelada pelo usu√°rio. Voc√™ pode tentar novamente a qualquer momento.";
        }
      } catch (error) {
        console.error('Erro ao adicionar token:', error);
        
        // Tratamento espec√≠fico para diferentes tipos de erro
        if (error.code === 4001) {
          metamaskStatus.className = "status warning";
          metamaskStatus.textContent = "‚ö†Ô∏è Solicita√ß√£o rejeitada pelo usu√°rio. Voc√™ pode tentar novamente clicando no bot√£o acima.";
        } else if (error.code === -32002) {
          metamaskStatus.className = "status warning";
          metamaskStatus.textContent = "‚ö†Ô∏è J√° existe uma solicita√ß√£o pendente no MetaMask. Verifique a extens√£o e aprove ou rejeite a solicita√ß√£o anterior.";
        } else if (error.code === -32603) {
          metamaskStatus.className = "status error";
          metamaskStatus.textContent = "‚ùå Erro interno do MetaMask. Tente recarregar a p√°gina e conectar novamente.";
        } else {
          metamaskStatus.className = "status error";
          metamaskStatus.textContent = `‚ùå Erro ao adicionar token: ${error.message || 'Erro desconhecido'}. C√≥digo: ${error.code || 'N/A'}`;
        }
      }
    }
    
    function reiniciarFluxo() {
      // Resetar vari√°veis
      currentStep = 1;
      tokenData = {};
      deployedTokenData = {};
      generatedContract = null;
      searchingSalt = false;
      
      // Limpar todos os campos
      document.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.type === 'number') {
          field.value = field.defaultValue || '';
        } else {
          field.value = '';
        }
      });
      
      // Resetar valores padr√£o
      document.getElementById('decimals').value = '18';
      document.getElementById('addressType').value = 'standard';
      
      // Esconder se√ß√µes condicionais
      document.getElementById('customization-section').style.display = 'none';
      document.getElementById('deploy-section').style.display = 'none';
      document.getElementById('salt-output').style.display = 'none';
      document.getElementById('deploy-output').style.display = 'none';
      
      // Resetar bot√µes
      document.getElementById('connect-wallet-btn').style.display = 'inline-block';
      document.getElementById('next-step-4').style.display = 'none';
      
      // Limpar status
      document.querySelectorAll('.status').forEach(status => {
        status.textContent = '';
        status.className = 'status';
      });
      
      // Atualizar display
      updateStepDisplay();
    }
    
    // ===== INICIALIZA√á√ÉO =====
    
    // Detectar mudan√ßas de rede
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.on('chainChanged', (chainId) => {
        window.location.reload();
      });
      
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          window.location.reload();
        }
      });
    }
  </script>
</body>
</html>

